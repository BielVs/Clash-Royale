<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatbot IA - Arena de Batalha do C√≥digo</title>
    <style>
      /* Importando fonte que lembra o estilo do jogo (opcional, mas recomendado) */
      @import url("https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap");

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Roboto", sans-serif; /* Fonte de estilo mais robusto */
      }

      body {
        /* Fundo que lembra o campo de batalha ou uma arena */
        background: linear-gradient(135deg, #1b5e20, #4caf50); /* Verde da arena */
        color: #333;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        width: 100%;
        max-width: 900px;
        /* Fundo que lembra a pedra ou madeira */
        background-color: #f7f7f7;
        border-radius: 20px; /* Bordas mais suaves */
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4); /* Sombra mais dram√°tica */
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 85vh;
        border: 5px solid #ffc107; /* Borda dourada/amarela, tema real */
      }

      .header {
        /* Tema azul escuro e dourado/amarelo */
        background: linear-gradient(to right, #212121, #424242); /* Preto/Cinza da torre/arena */
        color: white;
        padding: 20px;
        text-align: center;
        position: relative;
        border-bottom: 3px solid #ffc107;
      }

      .header h1 {
        font-size: 2rem;
        margin-bottom: 5px;
        color: #ffc107; /* Dourado */
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
      }

      .header p {
        font-size: 1rem;
        opacity: 0.9;
      }

      .python-logo {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 2.5rem;
        color: #03a9f4; /* Azul das cartas */
        transform: rotate(-10deg);
      }

      .chat-container {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .api-key-section {
        padding: 20px;
        background-color: #e8e8e8; /* Cor de fundo mais neutra */
        border-bottom: 1px solid #c0c0c0;
      }

      .api-key-form {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .api-key-input {
        flex: 1;
        min-width: 200px;
        padding: 12px 15px;
        border: 2px solid #9e9e9e;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
        background-color: white;
      }

      .api-key-input:focus {
        outline: none;
        border-color: #ff9800; /* Laranja da chama */
        box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.3);
      }

      .api-selector {
        width: 100%;
        margin-bottom: 10px;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .api-selector select {
        padding: 8px 12px;
        border-radius: 6px;
        border: 2px solid #9e9e9e;
        background-color: white;
        font-weight: 600;
      }

      .btn {
        padding: 12px 20px;
        /* Estilo de bot√£o de carta ou ba√∫ */
        background: linear-gradient(to right, #ff9800, #ff5722); /* Laranja/Vermelho */
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 700;
        transition: all 0.3s;
        text-transform: uppercase;
        box-shadow: 0 4px #e65100; /* Sombra 3D */
      }

      .btn:hover {
        background: linear-gradient(to right, #ffb74d, #ff7043);
        transform: translateY(-2px);
        box-shadow: 0 6px #e65100;
      }

      .btn:active {
        transform: translateY(2px);
        box-shadow: 0 2px #e65100;
      }

      .chat-box {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 15px;
        background-color: #ffffff; /* Fundo do chat claro */
      }

      .message {
        max-width: 80%;
        padding: 15px 20px;
        border-radius: 25px;
        line-height: 1.6;
        position: relative;
        animation: fadeIn 0.3s ease-out;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .user-message {
        align-self: flex-end;
        /* Cor azul da torre aliada */
        background: linear-gradient(to right, #03a9f4, #0288d1);
        color: white;
        border-bottom-right-radius: 5px;
      }

      .bot-message {
        align-self: flex-start;
        /* Cor cinza/clara da torre inimiga */
        background-color: #eeeeee;
        color: #333;
        border: 1px solid #bdbdbd;
        border-bottom-left-radius: 5px;
      }

      .warning-message {
        align-self: center;
        background-color: #fff8e1;
        color: #ff8f00;
        border: 2px solid #ffb300;
        border-radius: 12px;
        max-width: 90%;
        text-align: center;
        font-size: 0.95rem;
        font-weight: 700;
      }

      .error-message {
        align-self: center;
        background-color: #ffebee;
        color: #d32f2f;
        border: 2px solid #f44336;
        border-radius: 12px;
        max-width: 90%;
        text-align: center;
        font-size: 0.95rem;
        font-weight: 700;
      }

      .input-section {
        padding: 20px;
        background-color: #f7f7f7;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 10px;
        height: auto;
        float: left;
      }

      .message-input {
        flex: 1;
        padding: 12px 20px;
        border: 2px solid #bdbdbd;
        border-radius: 30px;
        font-size: 1rem;
        transition: all 0.3s;
        background-color: white;
      }

      .message-input:focus {
        outline: none;
        border-color: #ff9800;
        box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.3);
      }

      .send-btn {
        padding: 12px 20px;
        /* Estilo de bot√£o de elixir/carta */
        background: linear-gradient(to right, #00c853, #00a040); /* Verde elixir */
        color: white;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        font-weight: 700;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px #00701a;
      }

      .send-btn:hover {
        background: linear-gradient(to right, #38e873, #00c853);
        transform: translateY(-2px);
        box-shadow: 0 6px #00701a;
      }

      .send-btn:active {
        transform: translateY(2px);
        box-shadow: 0 2px #00701a;
      }

      .send-btn:disabled {
        background: #9e9e9e;
        cursor: not-allowed;
        transform: none;
        box-shadow: 0 4px #616161;
      }

      .typing-indicator {
        display: inline-block;
        padding: 12px 18px;
        background-color: #eeeeee;
        border: 1px solid #bdbdbd;
        border-radius: 18px;
        border-bottom-left-radius: 5px;
        align-self: flex-start;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .typing-dots {
        display: flex;
        gap: 4px;
      }

      .typing-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #03a9f4; /* Azul */
        animation: typing 1.4s infinite ease-in-out;
      }

      .typing-dot:nth-child(1) {
        animation-delay: -0.32s;
      }
      .typing-dot:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes typing {
        0%,
        80%,
        100% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .info-section {
        padding: 15px 20px;
        background-color: #fffde7; /* Amarelo claro/dourado */
        border-top: 2px solid #ffc107;
        font-size: 0.9rem;
        color: #ff8f00; /* Laranja escuro */
        text-align: center;
      }

      .info-section a {
        color: #d50000; /* Vermelho forte */
        text-decoration: none;
        font-weight: 700;
      }

      .info-section a:hover {
        text-decoration: underline;
      }

      .code-block {
        background-color: #212121; /* Fundo escuro para o c√≥digo */
        color: #00e676; /* Verde neon/elixir para o texto */
        border: 1px solid #a74caf;
        border-radius: 6px;
        padding: 15px;
        margin: 10px 0;
        font-family: "Courier New", monospace;
        font-size: 0.95rem;
        overflow-x: auto;
        white-space: pre-wrap;
      }

      .api-info {
        margin-top: 10px;
        font-size: 0.85rem;
        color: #424242;
        font-weight: 500;
      }

      @media (max-width: 768px) {
        .container {
          height: 95vh;
          border-radius: 15px;
        }

        .message {
          max-width: 90%;
        }

        .header h1 {
          font-size: 1.7rem;
        }

        .python-logo {
          font-size: 2rem;
          top: 18px;
        }

        .api-key-form {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Clashbot: Mestre da Arena!</h1>
        <p>A IA agora √© um Especialista em Clash Royale - Sem erros de Elixir!</p>
        <div class="python-logo">‚ö°</div>
      </div>

      <div class="chat-container">
        <div class="api-key-section">
          <div class="api-selector">
            <label for="apiProvider">Escolha sua Tropa (API):</label>
            <select id="apiProvider">
              <option value="gemini">
                Google Gemini (Recomendado - Ba√∫ Gr√°tis)
              </option>
              <option value="deepseek">DeepSeek (Pode Requerer Ouro/Gemas)</option>
            </select>
          </div>
          <div class="api-key-form">
            <input
              type="password"
              class="api-key-input"
              placeholder="Chave do Reino (API Key)..."
              id="apiKey"
            />
            <button class="btn" id="saveApiKey">Abrir Ba√∫</button>
          </div>
          <div class="api-info" id="apiInfo">
            Para Google Gemini: Obtenha seu Ba√∫ Gr√°tis em
            <a href="https://aistudio.google.com/app/apikey" target="_blank"
              >Google AI Studio</a
            >
          </div>
        </div>

        <div class="chat-box" id="chatBox">
          <div class="message bot-message">
            Bem-vindo √† Arena! Sou seu assistente de IA, agora sou um **Especialista em Clash Royale**. Escolha sua Tropa (API) e insira sua Chave do Reino. Estou pronto para ajudar com **estrat√©gias, custos de Elixir e estat√≠sticas de cartas**!
          </div>
        </div>

        <div class="input-section">
          <input
            type="text"
            class="message-input"
            placeholder="Lance seu feiti√ßo (Pergunta sobre Clash Royale ou estrat√©gias)..."
            id="messageInput"
            disabled
          />
          <button class="send-btn" id="sendMessage" disabled>
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M22 2L11 13"
                stroke="white"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M22 2L15 22L11 13L2 9L22 2Z"
                stroke="white"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </button>
        </div>

        <div class="info-section">
          <strong>Ba√∫s de Chaves:</strong> 
          <a href="https://aistudio.google.com/app/apikey" target="_blank"
            >Google AI Studio (Gemini)</a
          >
          | 
          <a href="https://platform.deepseek.com/api_keys" target="_blank"
            >DeepSeek Platform</a
          >
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const apiProviderSelect = document.getElementById("apiProvider");
        const apiKeyInput = document.getElementById("apiKey");
        const apiInfo = document.getElementById("apiInfo");
        const saveApiKeyBtn = document.getElementById("saveApiKey");
        const messageInput = document.getElementById("messageInput");
        const sendMessageBtn = document.getElementById("sendMessage");
        const chatBox = document.getElementById("chatBox");

        let apiKey = "";
        let apiProvider = "gemini";
        let isProcessing = false;

        // Atualizar informa√ß√µes da API quando o provedor mudar
        apiProviderSelect.addEventListener("change", function () {
          apiProvider = this.value;
          updateApiInfo();
        });

        function updateApiInfo() {
          if (apiProvider === "gemini") {
            apiInfo.innerHTML =
              'Para Google Gemini: Obtenha seu Ba√∫ Gr√°tis em <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>';
            apiKeyInput.placeholder = "Chave do Google Gemini...";
          } else {
            apiInfo.innerHTML =
              'Para DeepSeek: Obtenha sua chave em <a href="https://platform.deepseek.com/api_keys" target="_blank">DeepSeek Platform</a> (pode requerer pagamento)';
            apiKeyInput.placeholder = "Chave do DeepSeek...";
          }
        }

        // Inicializar informa√ß√µes da API
        updateApiInfo();

        // Salvar a chave da API
        saveApiKeyBtn.addEventListener("click", function () {
          apiKey = apiKeyInput.value.trim();

          if (!apiKey) {
            addMessage("üö® Erro: Insira a Chave do Reino (API Key) para entrar na batalha.", "warning");
            return;
          }

          // Esconder a chave na interface
          apiKeyInput.type = "password";
          apiKeyInput.value = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
          apiKeyInput.disabled = true;
          saveApiKeyBtn.disabled = true;
          apiProviderSelect.disabled = true;

          // Ativar campos de mensagem
          messageInput.disabled = false;
          sendMessageBtn.disabled = false;

          addMessage(
            "‚úÖ O Ba√∫ de Chaves foi aberto! A Chave da API " +
              (apiProvider === "gemini" ? "Google Gemini" : "DeepSeek") +
              " foi salva. Lance seus feiti√ßos (perguntas) sobre Clash Royale!",
            "bot"
          );
          messageInput.focus();
        });

        // Enviar mensagem ao clicar no bot√£o
        sendMessageBtn.addEventListener("click", sendMessage);

        // Enviar mensagem ao pressionar Enter
        messageInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter" && !isProcessing) {
            sendMessage();
          }
        });

        async function sendMessage() {
          const message = messageInput.value.trim();

          if (!message || isProcessing) return;

          // Adicionar mensagem do usu√°rio ao chat
          addMessage(message, "user");
          messageInput.value = "";

          // Mostrar indicador de digita√ß√£o
          showTypingIndicator();

          // Processar a pergunta
          await processQuestion(message);
        }

        async function processQuestion(question) {
          isProcessing = true;
          sendMessageBtn.disabled = true;

          try {
            let response;

            if (apiProvider === "gemini") {
              response = await callGeminiAPI(question);
            } else {
              response = await callDeepSeekAPI(question);
            }

            // Remover indicador de digita√ß√£o
            removeTypingIndicator();

            // Exibir a resposta
            addMessage(response, "bot");
          } catch (error) {
            console.error("Erro ao processar a pergunta:", error);
            removeTypingIndicator();

            let errorMessage =
              "üí• Defesa A√©rea Falhou: Ocorreu um erro ao processar sua pergunta. ";

            if (error.message.includes("402")) {
              errorMessage +=
                "Esta Tropa (API) requer Ouro/Gemas. Por favor, use o Google Gemini (Ba√∫ Gr√°tis).";
            } else if (error.message.includes("401")) {
              errorMessage +=
                "A Chave do Reino (API Key) est√° inv√°lida. Verifique sua chave e tente novamente.";
            } else if (error.message.includes("429")) {
              errorMessage +=
                "Limite de Elixir (Requisi√ß√µes) Excedido. Tente novamente mais tarde.";
            } else if (error.message.includes("500")) {
              errorMessage +=
                "Erro interno do Castelo (Servidor). Tente novamente em alguns instantes.";
            } else {
              errorMessage += `Detalhes do Ataque: ${error.message}`;
            }

            addMessage(errorMessage, "error");
          } finally {
            isProcessing = false;
            sendMessageBtn.disabled = false;
          }
        }

        async function callGeminiAPI(question) {
          // Usando a API do Google Gemini
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      // PROMPT OTIMIZADO PARA SER ESPECIALISTA EM CLASH ROYALE
                      text: `Voc√™ √© um Assistente e Especialista no jogo Clash Royale. Suas respostas devem ser baseadas em dados OFICIAIS do jogo (custos de Elixir, estat√≠sticas de tropas, nomes de cartas e arenas). Responda a todas as perguntas do usu√°rio com precis√£o. Se a pergunta n√£o for sobre Clash Royale, responda que voc√™ s√≥ pode ajudar com estrat√©gias da Arena.
Pergunta do usu√°rio: ${question}`,
                    },
                  ],
                },
              ],
              generationConfig: {
                temperature: 0.5, // Reduzi a temperatura para respostas mais factuais
                maxOutputTokens: 1000,
              },
            }),
          });

          if (!response.ok) {
            throw new Error(
              `Erro na API: ${response.status} - ${response.statusText}`
            );
          }

          const data = await response.json();

          if (data.candidates && data.candidates.length > 0) {
            return data.candidates[0].content.parts[0].text;
          } else {
            throw new Error("Resposta da API n√£o cont√©m dados v√°lidos");
          }
        }

        async function callDeepSeekAPI(question) {
          // Tentativa com a API DeepSeek (pode retornar erro 402)
          const response = await fetch(
            "https://api.deepseek.com/v1/chat/completions",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${apiKey}`,
              },
              body: JSON.stringify({
                model: "deepseek-chat",
                messages: [
                  {
                    role: "system",
                    // PROMPT OTIMIZADO PARA SER ESPECIALISTA EM CLASH ROYALE
                    content:
                      "Voc√™ √© um Assistente e Especialista no jogo Clash Royale. Suas respostas devem ser baseadas em dados OFICIAIS do jogo (custos de Elixir, estat√≠sticas de tropas, nomes de cartas e arenas). Responda a todas as perguntas do usu√°rio com precis√£o. Se a pergunta n√£o for sobre Clash Royale, responda que voc√™ s√≥ pode ajudar com estrat√©gias da Arena.",
                  },
                  {
                    role: "user",
                    content: question,
                  },
                ],
                max_tokens: 1000,
                temperature: 0.5, // Reduzi a temperatura para respostas mais factuais
              }),
            }
          );

          if (!response.ok) {
            throw new Error(
              `Erro na API: ${response.status} - ${response.statusText}`
            );
          }

          const data = await response.json();

          if (data.choices && data.choices.length > 0) {
            return data.choices[0].message.content;
          } else {
            throw new Error("Resposta da API n√£o cont√©m dados v√°lidos");
          }
        }

        function addMessage(text, sender) {
          const messageDiv = document.createElement("div");
          messageDiv.classList.add("message");

          if (sender === "user") {
            messageDiv.classList.add("user-message");
            messageDiv.textContent = text;
          } else if (sender === "bot") {
            messageDiv.classList.add("bot-message");

            // Processar a resposta para formatar blocos de c√≥digo
            const formattedText = formatCodeBlocks(text);
            messageDiv.innerHTML = formattedText;
          } else if (sender === "warning") {
            messageDiv.classList.add("warning-message");
            messageDiv.textContent = text;
          } else if (sender === "error") {
            messageDiv.classList.add("error-message");
            messageDiv.textContent = text;
          }

          chatBox.appendChild(messageDiv);

          // Rolagem autom√°tica para a √∫ltima mensagem
          chatBox.scrollTop = chatBox.scrollHeight;
        }

        function formatCodeBlocks(text) {
          // Substituir blocos de c√≥digo marcados com ``` por elementos pre/code
          return text.replace(
            /```(\w+)?\n([\s\S]*?)```/g,
            function (match, language, code) {
              return `<div class="code-block"><pre><code>${code.trim()}</code></pre></div>`;
            }
          );
        }

        function showTypingIndicator() {
          const typingDiv = document.createElement("div");
          typingDiv.classList.add("typing-indicator");
          typingDiv.id = "typingIndicator";

          const dotsDiv = document.createElement("div");
          dotsDiv.classList.add("typing-dots");

          for (let i = 0; i < 3; i++) {
            const dot = document.createElement("div");
            dot.classList.add("typing-dot");
            dotsDiv.appendChild(dot);
          }

          typingDiv.appendChild(dotsDiv);
          chatBox.appendChild(typingDiv);

          // Rolagem autom√°tica para o indicador de digita√ß√£o
          chatBox.scrollTop = chatBox.scrollHeight;
        }

        function removeTypingIndicator() {
          const typingIndicator = document.getElementById("typingIndicator");
          if (typingIndicator) {
            typingIndicator.remove();
          }
        }
      });
    </script>
  </body>
</html>